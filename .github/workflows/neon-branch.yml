name: Create Neon Branch for PR
# Creates isolated database branch for each PR to enable safe testing

on:
  pull_request:
    types: [opened, reopened, synchronize]

jobs:
  create-branch:
    runs-on: ubuntu-latest
    outputs:
      db_url: ${{ steps.create-branch.outputs.db_url }}
      branch_id: ${{ steps.create-branch.outputs.branch_id }}

    steps:
      - name: Create Neon Branch
        uses: neondatabase/create-branch-action@v5
        with:
          project_id: ${{ secrets.NEON_PROJECT_ID }}
          branch_name: pr-${{ github.event.number }}
          api_key: ${{ secrets.NEON_API_KEY }}
        id: create-branch

      - name: Comment PR with branch info
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## ðŸ—ƒï¸ Neon Database Branch Created

            A dedicated database branch has been created for this PR.

            | Property | Value |
            |----------|-------|
            | Branch Name | \`pr-${{ github.event.number }}\` |
            | Branch ID | \`${{ steps.create-branch.outputs.branch_id }}\` |

            This branch will be automatically deleted when the PR is closed.

            **Testing:** Your tests will run against this isolated branch.`;

            // Check if we already commented
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('Neon Database Branch Created')
            );

            if (!botComment) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  run-tests:
    needs: create-branch
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: ${{ needs.create-branch.outputs.db_url }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-asyncio

      - name: Run tests against PR branch
        run: |
          pytest tests/ -v --tb=short
        continue-on-error: true
