# Bug Fix: Telegram Bots Not Responding to Photos (2026-01-04)

## Problem
Telegram bots started successfully but did not respond to photos. OCR test passed locally, but production bots failed silently.

## Root Cause
1. **Image quality validation too strict** (0.80 thresholds rejected real equipment photos with reflective nameplates)
2. **Confidence threshold too high** (0.7 vs test's 0.3)
3. **No logging** to diagnose failures
4. **No timeout handling** for stuck downloads
5. **Multiple bot instances** running with same token (conflict)

## Fixes Applied

### Code Changes (Rivet-PRO)
✅ **Relaxed image quality validation** (`rivet/workflows/ocr.py`)
- Changed `max_dark_ratio: 0.80 → 0.90`
- Changed `max_bright_ratio: 0.80 → 0.90`
- Rationale: Real equipment photos have reflective nameplates and varied lighting

✅ **Lowered confidence threshold** (all telegram handlers)
- Changed `min_confidence: 0.7 → 0.5` in:
  - `telegram_shared.py:75`
  - `telegram_cmms_bot.py:153`
  - `telegram_rivet_bot.py:203`
  - `telegram.py:628`

✅ **Added comprehensive logging** (`telegram_shared.py`)
- `[PHOTO_START]` - Photo received with user ID
- `[PHOTO_DOWNLOAD]` - Download start, size, timeout
- `[PHOTO_OCR]` - OCR start and completion with provider/confidence
- Structured logging with extra fields for filtering

✅ **Added 30-second timeout** for photo downloads
- Uses `asyncio.wait_for()` to prevent hanging
- Clear error message if timeout occurs

✅ **Improved error messages**
- Classifies errors (timeout, quality, general)
- Provides actionable guidance to users

✅ **Fixed Unicode for Windows** (`rivet/config.py`)
- Replaced `✓` → `[OK]` and `✗` → `[NONE]`
- Prevents cp1252 encoding errors

### VPS Hardening (Agent-Factory)
✅ **Stopped duplicate services**
```bash
systemctl stop rivet-telegram-bot.service
systemctl disable rivet-telegram-bot.service
```
- Both `orchestrator-bot.service` and `rivet-telegram-bot.service` were running the same bot
- Caused "Conflict: terminated by other getUpdates request" errors

✅ **Applied same code fixes to Agent-Factory**
- `agent_factory/integrations/telegram/ocr/pipeline.py` - relaxed thresholds, added logging
- `agent_factory/integrations/telegram/orchestrator_bot.py` - timeout, logging

## Hardening Measures to Prevent Recurrence

### 1. Service Monitoring
**File**: `scripts/check_bot_conflicts.sh` (create this)
```bash
#!/bin/bash
# Check for duplicate bot processes
PROCESSES=$(ps aux | grep orchestrator_bot | grep -v grep | wc -l)
if [ $PROCESSES -gt 1 ]; then
    echo "ERROR: Multiple orchestrator_bot processes detected!"
    ps aux | grep orchestrator_bot | grep -v grep
    exit 1
fi
```

**Add to cron**: `0 * * * * /root/Agent-Factory/scripts/check_bot_conflicts.sh`

### 2. Systemd Service Hardening
**File**: `/etc/systemd/system/orchestrator-bot.service`
```ini
[Unit]
Description=Rivet Orchestrator Telegram Bot
After=network.target
Conflicts=rivet-telegram-bot.service  # ← ADD THIS LINE

[Service]
Type=simple
Restart=on-failure
RestartSec=30s
MaxRestarts=5  # ← ADD THIS LINE
```

### 3. Pre-deployment Checklist
Before deploying bots:
- [ ] Check no duplicate services: `systemctl list-units | grep -i bot`
- [ ] Verify single process: `ps aux | grep orchestrator_bot | wc -l` should be 1
- [ ] Test with photo locally first
- [ ] Check VPS logs: `journalctl -u orchestrator-bot -f | grep PHOTO`

### 4. Validation Thresholds Documentation
**File**: `rivet/workflows/ocr.py` (add docstring)
```python
# IMPORTANT: Thresholds set to 0.90 (not 0.80) because:
# - Real equipment photos have reflective metal nameplates (bright spots)
# - Shop floor lighting varies (shadows, bright spots)
# - OCR providers (GPT-4o, Gemini) are robust to imperfect lighting
# - False rejection costs more than false acceptance
# DO NOT lower below 0.90 without testing on real equipment photos
```

### 5. Deployment Script
**File**: `scripts/deploy_vps_bots.sh` (create this)
```bash
#!/bin/bash
set -e

echo "Deploying bot fixes to VPS..."

# 1. Stop duplicate services
ssh root@72.60.175.144 "systemctl stop rivet-telegram-bot.service || true"
ssh root@72.60.175.144 "systemctl disable rivet-telegram-bot.service || true"

# 2. Copy fixed files
scp rivet/workflows/ocr.py root@72.60.175.144:/root/Agent-Factory/agent_factory/integrations/telegram/ocr/pipeline.py
scp rivet/integrations/telegram_shared.py root@72.60.175.144:/root/Agent-Factory/agent_factory/integrations/telegram/

# 3. Restart single service
ssh root@72.60.175.144 "systemctl restart orchestrator-bot.service"

# 4. Verify single process
sleep 5
ssh root@72.60.175.144 "ps aux | grep orchestrator_bot | grep -v grep | wc -l"

echo "Deployment complete. Send test photo to verify."
```

### 6. Testing Protocol
**File**: `docs/TESTING_PHOTO_OCR.md` (create this)
```markdown
# Photo OCR Testing Protocol

## Before Deploying
1. Run local test: `python test_photo_handler.py`
2. Check thresholds match: `grep -n "0.90" rivet/workflows/ocr.py`
3. Verify logging: `grep -n "PHOTO_START\|PHOTO_DOWNLOAD\|PHOTO_OCR" rivet/integrations/telegram_shared.py`

## After Deploying
1. Send clear nameplate photo → Should work (confidence >70%)
2. Send photo with bright spots → Should work (after threshold fix)
3. Send completely black image → Should reject with clear message
4. Check VPS logs: `ssh root@72.60.175.144 "journalctl -u orchestrator-bot -f | grep PHOTO"`

## Expected Log Pattern
[PHOTO_START] Photo received from user 12345
[PHOTO_DOWNLOAD] Starting download. Size: 1920x1080
[PHOTO_DOWNLOAD] ✓ Downloaded. Size: 245KB
[PHOTO_OCR] Calling analyze_photo
Quality check passed: dark=15%, bright=20%
Trying gpt4o
[PHOTO_OCR] ✓ Completed. Provider: gpt4o, Confidence: 85%
```

## Verification
✅ Photo sent to @AgentFactoryRemote_bot → **OCR detected Rockwell Automation Micro820 (85% confidence)**
✅ All logging checkpoints present in VPS logs
✅ No bot conflicts
✅ Single orchestrator process running

## Commits
- Rivet-PRO: `c0db51e` - "Fix: Bots now respond to photos"
- Agent-Factory VPS: Applied manually on 2026-01-04

## Monitoring
Watch for these errors in future:
- `Conflict: terminated by other getUpdates request` → duplicate services
- `Image too dark/bright` → validation thresholds too strict
- Silent failures → check logging is enabled
- Timeout errors → check network/Telegram API

## Rollback Plan
If issues occur:
```bash
# Rivet-PRO
git revert c0db51e

# Agent-Factory VPS
ssh root@72.60.175.144 "cd Agent-Factory/agent_factory/integrations/telegram/ocr && mv pipeline.py.backup pipeline.py"
ssh root@72.60.175.144 "cd Agent-Factory/agent_factory/integrations/telegram && mv orchestrator_bot.py.backup orchestrator_bot.py"
ssh root@72.60.175.144 "systemctl restart orchestrator-bot.service"
```
