#!/usr/bin/env python3
"""
Ralph CLI - Command-line interface for Ralph autonomous coding agent.

Usage:
    ralph --help
    ralph story add "Implement feature X"
    ralph story status RALPH-001
    ralph story list --status todo
    ralph execute --max-calls 50
    ralph version
    ralph health
"""

import sys
import os
import argparse
import json
from pathlib import Path

# Add parent directory to path for imports
sys.path.insert(0, str(Path(__file__).parent.parent))

from src import __version__


def cmd_version(args):
    """Show Ralph version."""
    print(f"Ralph v{__version__}")
    print("Autonomous Coding Agent")


def cmd_health(args):
    """Check Ralph health status."""
    try:
        from src.ralph_api import RalphAPI
        ralph = RalphAPI()

        print("Ralph Health Check")
        print("-" * 40)

        # Check Anthropic API
        if ralph.client:
            print("[OK] Anthropic API: Connected")
        else:
            print("[!!] Anthropic API: Not configured")

        # Check Database
        if ralph.database_url:
            try:
                import psycopg2
                conn = psycopg2.connect(ralph.database_url)
                conn.close()
                print("[OK] Database: Connected")
            except Exception as e:
                print(f"[!!] Database: {e}")
        else:
            print("[!!] Database: Not configured")

        print("-" * 40)
        print("Status: healthy" if ralph.client else "Status: degraded")

    except Exception as e:
        print(f"Health check failed: {e}")
        sys.exit(1)


def cmd_story_list(args):
    """List stories."""
    try:
        from src.ralph_api import RalphAPI
        ralph = RalphAPI()

        stories = ralph.get_pending_stories(
            prefix=args.prefix,
            max_stories=args.limit or 20
        )

        if not stories:
            print("No stories found")
            return

        print(f"{'ID':<15} {'Status':<12} {'Priority':<8} {'Title'}")
        print("-" * 70)
        for story in stories:
            print(f"{story['story_id']:<15} {'todo':<12} {story['priority']:<8} {story['title'][:40]}")

    except Exception as e:
        print(f"Error listing stories: {e}")
        sys.exit(1)


def cmd_story_status(args):
    """Get story status."""
    try:
        from src.ralph_api import RalphAPI
        ralph = RalphAPI()

        stories = ralph.get_pending_stories(story_id=args.story_id)

        if not stories:
            print(f"Story {args.story_id} not found")
            sys.exit(1)

        story = stories[0]
        print(f"Story: {story['story_id']}")
        print(f"Title: {story['title']}")
        print(f"Priority: {story['priority']}")
        print(f"Description: {story['description']}")
        print(f"Criteria: {story['acceptance_criteria']}")

    except Exception as e:
        print(f"Error getting story status: {e}")
        sys.exit(1)


def cmd_story_add(args):
    """Add a new story."""
    story_id = args.story_id or f"RALPH-{int(__import__('time').time()) % 10000:04d}"

    print(f"Adding story: {story_id}")
    print(f"Title: {args.title}")
    print(f"Priority: {args.priority}")

    try:
        import psycopg2
        from src.ralph_api import RalphAPI
        ralph = RalphAPI()

        if not ralph.database_url:
            print("Error: DATABASE_URL not configured")
            sys.exit(1)

        conn = psycopg2.connect(ralph.database_url)
        with conn.cursor() as cur:
            cur.execute("""
                INSERT INTO ralph_stories
                (project_id, story_id, title, description, acceptance_criteria, priority, status)
                VALUES (1, %s, %s, %s, %s::jsonb, %s, 'todo')
            """, (
                story_id,
                args.title,
                args.description or args.title,
                json.dumps(args.criteria.split(',') if args.criteria else []),
                args.priority
            ))
        conn.commit()
        conn.close()

        print(f"[OK] Story {story_id} created")

    except Exception as e:
        print(f"Error adding story: {e}")
        sys.exit(1)


def cmd_execute(args):
    """Execute stories."""
    print("="*60)
    print("  Ralph Execution")
    print("="*60)
    print(f"Max stories: {args.max}")
    if args.prefix:
        print(f"Prefix filter: {args.prefix}")
    if args.story:
        print(f"Specific story: {args.story}")
    print()

    try:
        from src.ralph_api import RalphAPI
        ralph = RalphAPI()

        if not ralph.client:
            print("Error: Anthropic API not configured")
            sys.exit(1)

        stories = ralph.get_pending_stories(
            prefix=args.prefix,
            story_id=args.story,
            max_stories=args.max
        )

        print(f"Found {len(stories)} pending stories\n")

        if not stories:
            print("No pending stories found!")
            return

        completed = 0
        failed = 0

        for story in stories:
            ralph.update_story_status(story["story_id"], 'in_progress')

            success, result = ralph.execute_story(
                story["story_id"],
                story["title"],
                story["description"],
                str(story["acceptance_criteria"]),
                story["priority"],
                model=args.model
            )

            if success:
                commit_hash = result.get("commit_result", "")[:40] if result.get("commit_result") else None
                ralph.update_story_status(story["story_id"], 'done', commit_hash)
                print(f"[SUCCESS] {story['story_id']} completed")
                completed += 1
            else:
                ralph.update_story_status(story["story_id"], 'failed')
                print(f"[FAILED] {story['story_id']}: {result.get('error', 'Unknown error')}")
                failed += 1

        print(f"\n{'='*60}")
        print(f"Completed: {completed} | Failed: {failed}")
        print(f"{'='*60}")

    except Exception as e:
        print(f"Execution error: {e}")
        sys.exit(1)


def cmd_server(args):
    """Start API server."""
    try:
        from src.ralph_gateway import main as gateway_main
        sys.argv = ['ralph-server', '--host', args.host, '--port', str(args.port)]
        if args.reload:
            sys.argv.append('--reload')
        gateway_main()
    except Exception as e:
        print(f"Server error: {e}")
        sys.exit(1)


def main():
    parser = argparse.ArgumentParser(
        prog='ralph',
        description='Ralph - Autonomous Coding Agent CLI'
    )
    parser.add_argument('--version', action='store_true', help='Show version')

    subparsers = parser.add_subparsers(dest='command', help='Commands')

    # Version command
    version_parser = subparsers.add_parser('version', help='Show version')
    version_parser.set_defaults(func=cmd_version)

    # Health command
    health_parser = subparsers.add_parser('health', help='Check health status')
    health_parser.set_defaults(func=cmd_health)

    # Story commands
    story_parser = subparsers.add_parser('story', help='Story management')
    story_subparsers = story_parser.add_subparsers(dest='story_command')

    # story list
    story_list = story_subparsers.add_parser('list', help='List stories')
    story_list.add_argument('--status', help='Filter by status')
    story_list.add_argument('--prefix', help='Filter by ID prefix')
    story_list.add_argument('--limit', type=int, help='Max stories to show')
    story_list.set_defaults(func=cmd_story_list)

    # story status
    story_status = story_subparsers.add_parser('status', help='Get story status')
    story_status.add_argument('story_id', help='Story ID')
    story_status.set_defaults(func=cmd_story_status)

    # story add
    story_add = story_subparsers.add_parser('add', help='Add a new story')
    story_add.add_argument('title', help='Story title')
    story_add.add_argument('--id', dest='story_id', help='Story ID (auto-generated if not provided)')
    story_add.add_argument('--description', '-d', help='Story description')
    story_add.add_argument('--criteria', '-c', help='Acceptance criteria (comma-separated)')
    story_add.add_argument('--priority', '-p', type=int, default=0, help='Priority (lower = higher priority)')
    story_add.set_defaults(func=cmd_story_add)

    # Execute command
    execute_parser = subparsers.add_parser('execute', help='Execute stories')
    execute_parser.add_argument('--max', type=int, default=5, help='Max stories to execute')
    execute_parser.add_argument('--prefix', help='Story ID prefix filter')
    execute_parser.add_argument('--story', help='Specific story ID')
    execute_parser.add_argument('--model', default='claude-sonnet-4-20250514', help='Claude model')
    execute_parser.set_defaults(func=cmd_execute)

    # Server command
    server_parser = subparsers.add_parser('server', help='Start API server')
    server_parser.add_argument('--host', default='0.0.0.0', help='Host to bind')
    server_parser.add_argument('--port', type=int, default=8765, help='Port to listen')
    server_parser.add_argument('--reload', action='store_true', help='Enable auto-reload')
    server_parser.set_defaults(func=cmd_server)

    args = parser.parse_args()

    if args.version:
        cmd_version(args)
        return

    if not args.command:
        parser.print_help()
        return

    if args.command == 'story' and not hasattr(args, 'func'):
        story_parser.print_help()
        return

    if hasattr(args, 'func'):
        args.func(args)
    else:
        parser.print_help()


if __name__ == '__main__':
    main()
