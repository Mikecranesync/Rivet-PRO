# Ralph Progress Log
Started: Tue, Jan 13, 2026  5:43:12 PM
---

=== Bug Fixes Round 1 ===
Started: Tue, Jan 13, 2026  7:24:45 PM
Branch: ralph/bug-fixes-round1
Stories: FEEDBACK-LINK-001, FEEDBACK-USEREG-001, CRITICAL-MANUAL-001, FEEDBACK-LIMIT-001, CRITICAL-LOGGING-001
---

## 2026-01-13 - FEEDBACK-LINK-001
- Fixed PDF links not opening on mobile (underscore escape)
- Added plain URL fallback in backticks for copy/paste
- Files changed: rivet_pro/core/utils/response_formatter.py
- Commit: 2a49f63

## 2026-01-13 - FEEDBACK-USEREG-001
- Added user creation in /start command handler
- Uses ON CONFLICT for idempotent behavior
- Files changed: rivet_pro/adapters/telegram/bot.py
- Commit: f6c7db7

## 2026-01-13 - CRITICAL-MANUAL-001
- Fixed misleading log message (now shows Tavily vs n8n)
- Expanded URL pre-filter to include more doc paths
- Files changed: rivet_pro/core/services/manual_service.py
- Commit: 09bd082

## 2026-01-13 - FEEDBACK-LIMIT-001
- Already resolved: User 8445149012 set to Pro tier
- usage_service.py correctly bypasses limits for Pro users
- No code changes needed

## 2026-01-13 - CRITICAL-LOGGING-001
- Added interaction logging for ALL equipment lookups
- Fixed telegram_id passed as integer (was string)
- Updated interaction with equipment_id and outcome
- Files changed: rivet_pro/adapters/telegram/bot.py
- Commit: e61e628

**Learnings for future iterations:**
- Telegram Markdown requires escaping underscores in URLs: use url.replace('_', r'\_')
- telegram_id in users table is bigint, pass as integer not string
- Interactions should be logged early in flow, then updated as more data comes
- Always provide fallback copy-able URLs for mobile users
---

=== Phase 4: SME Chat with LLM Interaction ===
Started: Thu, Jan 16, 2026
Branch: ralph/sme-chat-phase4
Stories: SME-CHAT-001 through SME-CHAT-010
---

## 2026-01-16 - SME-CHAT-003
- Created rivet/prompts/sme/personalities.py with 7 vendor SME personalities
- Used dataclasses (SMEPersonality, SMEVoice) for structured personality definitions
- Each SME has: name, tagline, voice characteristics, expertise_areas, system_prompt_additions
- Helper functions: get_personality(), get_personality_by_enum(), build_system_prompt(), format_sme_response()
- Files changed: rivet/prompts/sme/personalities.py (new, 478 lines)
- Commit: 213b99c

**Learnings for future iterations:**
- SME models already exist in rivet/models/sme_chat.py with SMEVendor enum
- Existing SME prompts in rivet/prompts/sme/*.py have troubleshooting functions - personalities.py adds voice/chat characteristics
- Use dataclasses for structured config, Pydantic for validated models
- Personality system_prompt_additions should be concise but distinctive
---

## 2026-01-16 - SME-CHAT-004
- Created rivet/services/sme_rag_service.py for RAG context retrieval
- SMERagService.get_relevant_context() is the main async method
- Builds enhanced query from conversation history + equipment context
- Uses EmbeddingService and KnowledgeService.vector_search with manufacturer filter
- Helper functions: calculate_rag_confidence(), extract_sources_from_atoms()
- Updated rivet/services/__init__.py with exports
- Files changed: rivet/services/sme_rag_service.py (new), rivet/services/__init__.py
- Commit: b383c71

**Learnings for future iterations:**
- KnowledgeService.vector_search expects manufacturer to be capitalized (e.g., "Siemens" not "siemens")
- Confidence formula: (top_similarity * 0.6) + (avg_top3_similarity * 0.4)
- Truncate enhanced query to ~2000 chars for embedding to avoid token limits
---

## 2026-01-16 - SME-CHAT-005
- Created rivet/services/sme_chat_service.py (515 lines) - core SME chat orchestration
- SMEChatService class with start_session(), chat(), close_session() methods
- Session lifecycle: creates DB session, adds system message with personality
- Chat flow: load session -> get history -> RAG context -> build prompt -> LLM response
- Safety pattern extraction via regex (voltage, LOTO, arc flash, safety systems, mechanical, chemical)
- Confidence level mapping: HIGH (>=0.85), MEDIUM (0.70-0.85), LOW (<0.70)
- Uses LLMRouter.generate with ModelCapability.MODERATE
- Updated rivet/services/__init__.py with SMEChatService export
- Files changed: rivet/services/sme_chat_service.py (new), rivet/services/__init__.py
- Commit: f365592

**Learnings for future iterations:**
- LLMRouter returns LLMResponse with text, cost_usd, model, provider fields
- Safety patterns should use case-insensitive regex (response_lower)
- Store rag_atoms_used as UUID array for tracking which atoms contributed to response
- Keep fallback response for LLM failures to maintain conversation flow
---

## 2026-01-16 - SME-CHAT-006
- Added /chat and /endchat commands to rivet/integrations/telegram.py
- /chat [vendor] starts SME session with specific vendor
- /chat without args shows vendor picker (inline keyboard)
- Auto-detects vendor from recent equipment context (pending_equipment)
- /endchat closes active session and clears user_data
- Stores sme_session_id, sme_chat_active, sme_vendor, sme_name in context.user_data
- Sends SME greeting with personality name and tagline
- CommandHandler registered in setup_bot() for both commands
- BotCommand menu updated for Telegram command hints
- Fixed pre-existing import bug in kb_search.py (llm_router -> llm)
- Files changed: rivet/integrations/telegram.py, rivet/workflows/kb_search.py
- Commit: d8324cb

**Learnings for future iterations:**
- Telegram inline keyboards use callback_data prefix pattern (sme_vendor_xxx)
- Store session info in context.user_data for persistence across messages
- Use get_personality() from personalities.py for greeting construction
- Include aliases for vendors (allen-bradley, ab -> rockwell)
---

## 2026-01-16 - SME-CHAT-007
- Updated message_handler to check sme_chat_active at start
- Added handle_sme_chat_message function for SME chat routing
- Calls SMEChatService.chat() with session_id from user_data
- Added format_sme_chat_response for Telegram display
- Response includes: SME name badge, confidence emoji, answer, safety warnings, sources
- Confidence indicator: green (>=0.85), yellow (0.70-0.85), orange (<0.70)
- Error handling tracks consecutive failures (sme_error_count)
- After 3+ errors, suggests /endchat and restart
- Typing indicator shown during processing
- Files changed: rivet/integrations/telegram.py
- Commit: fdd77de

**Learnings for future iterations:**
- Track error counts in user_data for progressive error handling
- Use confidence_level.value to get string from enum
- Limit sources display (3 max) and truncate long source strings
- Include footer reminder about /endchat command
---

## 2026-01-16 - SME-CHAT-008
- Added _route_by_confidence method to SMEChatService
- HIGH (>=0.85): _format_direct_kb_answer - minimal LLM styling, uses SIMPLE capability
- MEDIUM (0.70-0.85): _generate_sme_synthesis - full SME synthesis, MODERATE capability
- LOW (<0.70): _generate_clarifying_questions - asks for more info, SIMPLE capability
- Each route maintains SME personality voice
- HIGH confidence uses temp=0.3 for consistency, LOW uses temp=0.5
- Confidence calculation formula already in calculate_rag_confidence()
- Integration with chat() flow via _route_by_confidence dispatch
- Files changed: rivet/services/sme_chat_service.py
- Commit: 2aefbde

**Learnings for future iterations:**
- Use cheaper model (SIMPLE) for high confidence since KB is authoritative
- Use cheaper model for clarifying questions - they don't need synthesis
- Ask clarifying questions when low confidence rather than hallucinating
- Include partial matches in clarifying questions for context
---

## 2026-01-16 - SME-CHAT-009
- Created tests/unit/test_sme_personalities.py with 19 tests
  - All 7 personalities load correctly
  - get_personality, get_personality_by_enum functions work
  - build_system_prompt includes voice elements and equipment context
  - format_sme_response handles warnings, sources, confidence indicators
- Created tests/unit/test_sme_chat_service.py with 19 tests
  - start_session creates record and adds system message
  - chat returns properly formatted SMEChatResponse with all fields
  - close_session updates status correctly
  - Confidence level calculation (HIGH/MEDIUM/LOW)
  - Safety warning extraction (voltage, LOTO, arc flash)
  - get_session and get_active_session work correctly
- Fixed bug in sme_chat_service.py - removed .value calls on enum fields
  - Pydantic use_enum_values=True means enums are already strings
- Files changed: tests/unit/test_sme_*.py (new), rivet/services/sme_chat_service.py
- Commit: 8910f51

**Learnings for future iterations:**
- Pydantic use_enum_values=True stores enum as primitive value, not enum object
- When mocking database for tests, use side_effect for multiple fetch_one calls
- Use patch() context manager to avoid settings/config loading issues in tests
- Track consecutive errors in user_data for progressive error handling
---

## 2026-01-16 - SME-CHAT-010
- Created tests/integration/test_sme_chat_flow.py with 12 tests
  - TestSiemensSession: Start session, chat with Hans, extract safety warnings
  - TestMultiTurnConversation: Multi-turn preserves context in RAG queries
  - TestRAGIntegration: Atoms included in response, confidence reflects similarity
  - TestSessionLifecycle: Close session, error on closed, get active session
  - TestDifferentVendors: Rockwell (Mike), ABB (Erik) personality verification
  - TestEquipmentContext: Session preserves OCR equipment context
- Fixed asyncpg JSONB handling in sme_chat_service.py
  - Serialize equipment_context as JSON string with json.dumps() for INSERT
  - Parse JSONB results (handle both string and dict) consistently
  - Added _result_to_session() helper for DRY session creation
- All integration tests use real database but mock LLM for determinism
- Files changed: tests/integration/test_sme_chat_flow.py (new), rivet/services/sme_chat_service.py
- Commit: b119989

**Learnings for future iterations:**
- asyncpg requires JSONB to be passed as a JSON string with ::jsonb cast
- JSONB may return as string or dict depending on query context - always handle both
- Integration tests should use unique IDs (timestamp-based) to avoid collisions
- Cleanup fixtures with autouse=True ensure test isolation
---

=== Phase 4: SME Chat COMPLETE ===
All 10 stories implemented and passing:
- SME-CHAT-001: Database migration (026_sme_chat_sessions.sql)
- SME-CHAT-002: Pydantic models (rivet/models/sme_chat.py)
- SME-CHAT-003: SME personalities (rivet/prompts/sme/personalities.py)
- SME-CHAT-004: RAG service (rivet/services/sme_rag_service.py)
- SME-CHAT-005: Chat service core (rivet/services/sme_chat_service.py)
- SME-CHAT-006: Telegram /chat command
- SME-CHAT-007: Telegram message routing
- SME-CHAT-008: Confidence-based routing
- SME-CHAT-009: Unit tests (38 tests)
- SME-CHAT-010: Integration tests (12 tests)

Total: 50 tests passing
---

=== Technical Debt Cleanup Sprint ===
Started: Thu, Jan 16, 2026
Branch: ralph/tech-debt-cleanup
Stories: DEBT-001 through DEBT-004
---

## 2026-01-16 - DEBT-001
- Extracted hardcoded chat ID (8445149012) to settings.telegram_admin_chat_id
- Added telegram_admin_chat_id to rivet_pro/config/settings.py with default value
- Updated 8 files to use config instead of hardcoded value
- Added TELEGRAM_ADMIN_CHAT_ID to .env.example for documentation
- Files using fallback to env var for robustness when settings unavailable
- Files changed: settings.py, bot.py, agent_executor.py, alerting_service.py, equipment_service.py, resilient_telegram_manager.py, database.py, test_ocr_flow.py, commands.py, .env.example
- Commit: d17ba61

**Learnings for future iterations:**
- Use try/except ImportError pattern for config fallbacks
- Keep hardcoded defaults in settings.py as single source of truth
- Update .env.example when adding new settings
---

## 2026-01-16 - DEBT-002
- Created migration 027_node_callback_mappings.sql with PostgreSQL persistent storage
- Table has tree_id, node_hash, node_id with 24-hour auto-expiry
- Updated callback.py with async DB functions + in-memory cache
- Graceful fallback to in-memory if DB unavailable
- Fire-and-forget pattern for sync->async DB writes
- Added cleanup_expired_mappings() function for maintenance
- Files changed: callback.py, 027_node_callback_mappings.sql
- Commit: 497c23d

**Learnings for future iterations:**
- Use asyncio.create_task for fire-and-forget from sync context
- Keep in-memory cache as fast path, DB as persistent backup
- Upsert (ON CONFLICT DO UPDATE) handles duplicate key gracefully
- Expiry column enables automatic cleanup without cron jobs
---

## 2026-01-16 - DEBT-003
- Implemented _query_cached_trees() with fuzzy ILIKE matching
- Implemented _load_tree_from_db() with 5-minute in-memory cache
- Added _find_best_matching_tree() with Jaccard similarity scoring
- Created troubleshooting_trees table in database (ad-hoc SQL)
- Updated get_or_generate_troubleshooting() to check DB before Claude
- Added _format_steps_for_telegram() for displaying cached guides
- Files changed: rivet_pro/troubleshooting/fallback.py
- Commit: 8d0b555

**Learnings for future iterations:**
- Use ILIKE for case-insensitive fuzzy matching in PostgreSQL
- Jaccard similarity (word intersection/union) is simple but effective
- Cache TTL (5 min) balances freshness vs performance
- Track usage_count to rank popular trees higher
---

## 2026-01-16 - DEBT-004
- Replaced 3 remaining bare except:pass statements with proper logging
- bot.py: Log KB report alert failures with warning level
- feedback_service.py: Log acceptance_criteria parse failures at debug level
- test_drafts.py: Documented expected cleanup failures in test fixtures
- grep 'except.*:.*pass' rivet_pro/ now returns 0 results
- Files changed: bot.py, feedback_service.py, test_drafts.py
- Commit: fc51ef8

**Learnings for future iterations:**
- Use specific exception types (json.JSONDecodeError, TypeError) not bare except
- Test fixture cleanup can use pass with a comment explaining why it's acceptable
- Debug level logging for expected/non-critical parse failures
- Warning level for alert/notification failures
---

=== Technical Debt Cleanup Sprint COMPLETE ===
All 4 stories implemented and passing:
- DEBT-001: Extracted hardcoded chat ID to settings (d17ba61)
- DEBT-002: Persistent callback storage with PostgreSQL (497c23d)
- DEBT-003: Troubleshooting tree DB query with fuzzy match (8d0b555)
- DEBT-004: Silent error handling cleanup (fc51ef8)

Ready for Phase 5 or merge to main.
---

=== Phase 5: Analytics Dashboard ===
Started: Thu, Jan 16, 2026
Branch: ralph/analytics-phase5
Stories: ANALYTICS-001 through ANALYTICS-006
---

## 2026-01-16 - ANALYTICS-001, 002, 003, 005
- Created rivet_pro/core/services/analytics_service.py (new, 583 lines)
- DailyStats, KBHealthMetrics, SMEChatMetrics dataclasses
- aggregate_daily_stats() - aggregates from interactions table with upsert
- get_today_stats() - real-time dashboard data with top equipment
- get_kb_health() - total atoms, by manufacturer, coverage gaps, stale atoms
- get_sme_chat_analytics() - sessions by vendor, avg messages, confidence distribution
- generate_weekly_report() - formatted Telegram report with trend arrows
- Files changed: rivet_pro/core/services/analytics_service.py (new)
- Commit: 9520678

**Learnings for future iterations:**
- Use FILTER clause in PostgreSQL for conditional aggregation
- Dataclasses are cleaner than Dict for structured return types
- Confidence distribution tracks HIGH/MEDIUM/LOW from sme_chat_messages
---

## 2026-01-16 - ANALYTICS-004
- Added /adminstats command for admin users (quick stats)
- Added /report command for weekly report generation
- Admin check uses telegram_admin_chat_id from settings
- Integrated AnalyticsService into TelegramBot class
- Service initialized after database connection in start()
- Files changed: rivet_pro/adapters/telegram/bot.py
- Commit: fc36b08

**Learnings for future iterations:**
- Compare telegram_user_id as int not str for admin check
- Initialize services after db pool is ready
- Use CommandHandler registration for slash commands
---

## 2026-01-16 - ANALYTICS-006
- Added _log_response_time() helper to bot.py for timing all handlers
- Uses time.perf_counter() for millisecond precision
- Logs to rivet_usage_log table with latency_ms column
- Slow queries (>5000ms) flagged with warning log
- Added get_response_time_stats() to analytics_service.py
- Updated format_stats_message() to show avg response time in /adminstats
- Files changed: bot.py, analytics_service.py
- Commit: 8d5c81c

**Learnings for future iterations:**
- time.perf_counter() is more accurate than time.time() for latency
- Use int() for ms to avoid float precision issues in DB
- Display slow query count only if > 0 to reduce noise
---

=== Phase 5: Analytics Dashboard COMPLETE ===
All 6 stories implemented and passing:
- ANALYTICS-001: Daily usage statistics aggregation (9520678)
- ANALYTICS-002: KB health metrics (9520678)
- ANALYTICS-003: SME chat analytics (9520678)
- ANALYTICS-004: Admin /adminstats and /report commands (fc36b08)
- ANALYTICS-005: Weekly report generation (9520678)
- ANALYTICS-006: Response time tracking (8d5c81c)

Ready for commit and merge to main.
---

=== YCB v3: Professional Video Generation ===
Started: Fri, Jan 17, 2026
Branch: ralph/ycb-v3-manim-blender
Stories: YCB3-MANIM-001 through YCB3-DOCS-001 (18 stories)
---

## Codebase Patterns (YCB v3)
- Use subprocess to run Manim CLI avoiding asyncio conflicts
- Manim output path: media_dir/videos/<script_name>/<quality>/<scene_name>.mp4
- Handle file rename collisions with unlink before rename
- Scene configs use dataclasses for structured descriptions
- Color palettes: INDUSTRIAL_COLORS for consistent theming
---

## 2026-01-17 - YCB3-MANIM-001
- Created ycb/rendering/__init__.py with module exports
- Created ycb/rendering/scene_types.py with Pydantic scene models
  - SceneType enum: TITLE, TEXT, DIAGRAM, FLOWCHART, COMPARISON, LADDER_LOGIC, TIMELINE
  - SceneConfig, TextConfig, ShapeConfig, ArrowConfig, DiagramConfig dataclasses
  - Preset color palettes: INDUSTRIAL_COLORS, PLC_COLORS
- Created ycb/rendering/manim_engine.py with ManimEngine class
  - render_title(), render_diagram(), render_text(), render_test() methods
  - Generates Manim Python code dynamically from scene configs
  - Runs Manim as subprocess with quality presets
  - Handles file output, renaming, and cleanup
- All tests pass: title, diagram, and text scenes render successfully
- Files changed: ycb/rendering/__init__.py, manim_engine.py, scene_types.py
- Commit: c8103f0

**Learnings for future iterations:**
- Manim requires running via subprocess to avoid asyncio conflicts
- Use f-strings carefully in generated code - escape quotes properly
- Label newlines must be replaced before code generation
- Output file detection requires checking multiple possible paths
- Quality presets: -ql (low), -qm (medium), -qh (high), -qp (production)
---

## 2026-01-17 - YCB3-ASSETS-001
- Created ycb/assets/electrical/ directory with 11 IEC-standard SVG symbols
- Symbols created: motor, relay, contactor, overload, transformer, fuse, switch
- PLC I/O symbols: digital_input, digital_output, analog_input, analog_output
- Each symbol uses 100x100 viewBox with consistent sizing
- Colors: Blue (#3B82F6) for control, Green (#22C55E) for inputs, Red (#EF4444) for protection
- Created manifest.json with metadata: categories, colors, connection points, descriptions
- Created test_svg_import.py to verify Manim can import and animate SVGs
- Test renders motor, relay, and digital input with labels and scaling animations
- All tests pass - SVGs import cleanly into Manim scenes
- Files changed: ycb/assets/electrical/*.svg (11 files), manifest.json, test_svg_import.py
- Commit: 1760c53

**Learnings for future iterations:**
- Manim SVGMobject requires .as_posix() for Windows path compatibility
- Use simple SVG elements (rect, line, circle, path, polygon) for best compatibility
- Include connection points in manifest for wiring diagrams
- Keep consistent stroke-width (2-3px) for visual cohesion
---

## 2026-01-17 - YCB3-ASSETS-002
- Created ycb/assets/plc/ directory with 19 SVG components
- Hardware (4 files): plc_rack, cpu_module, io_module, power_supply
- Ladder logic (9 files): XIC, XIO, OTE, OTL, OTU, TON, TOF, CTU, CTD
- Communication (4 files): Ethernet, Serial, Modbus, PROFINET
- All use industrial color scheme (grays #2D3748/#4A5568, blues, greens)
- Created manifest.json with categories, sizes, anchor points
- Created test_plc_import.py testing hardware rack and ladder logic rendering
- Both tests pass: PLC hardware and ladder logic Manim imports work
- Files: 19 SVGs + manifest.json + test script
- Commit: 1d85798

**Learnings for future iterations:**
- Ladder logic contacts use simple lines for Manim compatibility
- Timer/counter blocks use box style with parameters section
- Communication icons include protocol labels for clarity
- PLC rack designed for module overlay positioning
---

## 2026-01-17 - YCB3-MANIM-002
- Created ycb/rendering/templates.py with 6 reusable template classes
- TitleTemplate: Animated title cards with optional underline and subtitle
- DiagramTemplate: Technical diagrams with elements, arrows, and callouts
- FlowchartTemplate: Process flows with diamond/oval/rectangle shapes
- ComparisonTemplate: Side-by-side table comparisons with highlighting
- LadderLogicTemplate: PLC ladder diagrams with XIC/XIO contacts and OTE coils
- TimelineTemplate: Sequential process timelines (horizontal/vertical)
- Added TemplateFactory for easy instantiation
- Added TransitionType enum for animation styles
- Updated color palettes with arrow, success, rail, contact, coil, active colors
- Created test_templates.py with comprehensive test suite
- All 7 tests pass (each template + factory)
- Updated __init__.py with all template exports
- Files: templates.py (~900 lines), test_templates.py, updated __init__.py, scene_types.py
- Commit: 7c51bd2

**Learnings for future iterations:**
- Templates generate Manim code strings that are written to temp files and run as subprocess
- Use dataclasses for config, generate_code() method for Manim Python output
- Pad comparison table rows to match column count to avoid missing cell errors
- Ladder logic uses Arc for coil parentheses, Line for contacts
---

## 2026-01-17 - YCB3-STORY-001
- Created ycb/storyboard/ module for AI-powered storyboard generation
- models.py: Scene, Storyboard, VisualDescription, TemplateParameters, SceneType, RenderEngine
- generator.py: StoryboardGenerator class with LLM and rule-based modes
- LLM mode uses Groq API with detailed system prompts for scene planning
- Rule-based fallback: paragraph splitting, keyword detection, scene type inference
- Scene type inference: comparison (vs, compared), flowchart (step, sequence), ladder_logic, diagram
- Template params generated per scene type (elements, arrows, steps, events, etc.)
- Duration estimated from word count at ~2.5 words/second
- Serialization via to_dict() methods on all models
- Test suite: 4/4 tests pass (rule-based, serialization, params, custom config)
- Files: __init__.py, models.py, generator.py, test_generator.py
- Commit: 44b7692

**Learnings for future iterations:**
- Use dataclasses for models, to_dict() for JSON serialization
- LLM prompts should request JSON output with specific structure
- Rule-based fallback ensures functionality without API keys
- Word count / speaking rate = duration estimate
---
