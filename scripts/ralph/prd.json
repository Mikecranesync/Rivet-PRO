{
  "project": "RIVET Pro",
  "branchName": "ralph/whatsapp-adapter",
  "description": "WhatsApp Cloud API Adapter - Add WhatsApp support as a completely separate adapter. Uses Meta Cloud API webhooks. Does NOT touch existing Telegram code. Uses existing database whatsapp_id field.",
  "userStories": [
    {
      "id": "WHATSAPP-001",
      "title": "Update Config Settings",
      "description": "Update the WhatsApp configuration fields in Settings class with proper descriptions. Add 5 WhatsApp config fields: whatsapp_phone_number_id, whatsapp_business_account_id, whatsapp_access_token, whatsapp_verify_token, whatsapp_app_secret. All fields should be Optional with clear descriptions.",
      "acceptanceCriteria": [
        "All 5 WhatsApp config fields have clear descriptions",
        "Fields are Optional (adapter disabled if not set)",
        "Existing settings unchanged"
      ],
      "priority": 1,
      "passes": false,
      "notes": "File: rivet_pro/config/settings.py"
    },
    {
      "id": "WHATSAPP-002",
      "title": "Update .env.example",
      "description": "Add a commented WhatsApp section to .env.example with all required env vars: WHATSAPP_PHONE_NUMBER_ID, WHATSAPP_BUSINESS_ACCOUNT_ID, WHATSAPP_ACCESS_TOKEN, WHATSAPP_VERIFY_TOKEN, WHATSAPP_APP_SECRET. Include helpful comments explaining where to get these values from Meta Developer Portal.",
      "acceptanceCriteria": [
        "WhatsApp section clearly commented",
        "All 5 env vars listed",
        "Noted as optional (adapter disabled if not set)"
      ],
      "priority": 2,
      "passes": false,
      "notes": "File: .env.example or rivet_pro/.env.example"
    },
    {
      "id": "WHATSAPP-003",
      "title": "Create WhatsApp Client Module",
      "description": "Create rivet_pro/adapters/whatsapp/client.py with stubbed functions for sending messages via WhatsApp Cloud API. Include: send_whatsapp_text(to_whatsapp_id, body), send_whatsapp_image(to_whatsapp_id, image_url, caption), mark_as_read(message_id). All functions async with proper type hints and docstrings. Log what would be sent without exposing secrets.",
      "acceptanceCriteria": [
        "Three functions defined: send_whatsapp_text, send_whatsapp_image, mark_as_read",
        "All functions are async",
        "Proper type hints and docstrings",
        "Logging shows what would be sent (no secrets in logs)",
        "Uses settings for config access"
      ],
      "priority": 3,
      "passes": false,
      "notes": "File: rivet_pro/adapters/whatsapp/client.py (CREATE)"
    },
    {
      "id": "WHATSAPP-004",
      "title": "Create WhatsApp Webhook Router",
      "description": "Create rivet_pro/adapters/web/routers/whatsapp.py with FastAPI router. Include GET endpoint for Meta webhook verification (hub.mode, hub.verify_token, hub.challenge) and POST endpoint for receiving messages. Implement HMAC-SHA256 signature verification. Handle text and image message types. Return 403 for invalid token, 401 for invalid signature.",
      "acceptanceCriteria": [
        "GET /whatsapp handles webhook verification",
        "POST /whatsapp receives and validates messages",
        "Signature verification using HMAC-SHA256",
        "Returns 403 for invalid verify token",
        "Returns 401 for invalid signature",
        "Handles text and image message types",
        "No secrets logged",
        "Pure function for signature verification (testable)"
      ],
      "priority": 4,
      "passes": false,
      "notes": "File: rivet_pro/adapters/web/routers/whatsapp.py (CREATE)"
    },
    {
      "id": "WHATSAPP-005",
      "title": "Update WhatsApp __init__.py",
      "description": "Update rivet_pro/adapters/whatsapp/__init__.py to export the WhatsApp adapter entry points. Include module docstring explaining purpose and listing required config vars. Export send_whatsapp_text, send_whatsapp_image, mark_as_read from client module.",
      "acceptanceCriteria": [
        "Module docstring explains purpose",
        "Exports all client functions",
        "Lists required config vars in docstring"
      ],
      "priority": 5,
      "passes": false,
      "notes": "File: rivet_pro/adapters/whatsapp/__init__.py (MODIFY)"
    },
    {
      "id": "WHATSAPP-006",
      "title": "Wire Router into FastAPI App",
      "description": "Modify rivet_pro/adapters/web/main.py to include the WhatsApp router. Import whatsapp router from routers module. Register with /whatsapp prefix and WhatsApp tag. Add comment explaining adapter isolation. Ensure app still starts without WhatsApp config.",
      "acceptanceCriteria": [
        "WhatsApp router imported",
        "Router registered with /whatsapp prefix",
        "Comment explains adapter isolation",
        "Import does not pull in Telegram code",
        "FastAPI app still starts without WhatsApp config"
      ],
      "priority": 6,
      "passes": false,
      "notes": "File: rivet_pro/adapters/web/main.py (MODIFY)"
    },
    {
      "id": "WHATSAPP-007",
      "title": "Add WhatsApp Setup Documentation",
      "description": "Create docs/WHATSAPP_SETUP.md with setup instructions. Include: Prerequisites (Meta Business Account, WhatsApp Business API), Configuration steps with Meta Developer Portal, .env setup, Webhook setup with ngrok for local testing, curl examples for testing both endpoints, Security notes about secrets.",
      "acceptanceCriteria": [
        "Clear step-by-step setup instructions",
        "ngrok local testing guide",
        "curl examples for both endpoints",
        "Security warnings about secrets"
      ],
      "priority": 7,
      "passes": false,
      "notes": "File: docs/WHATSAPP_SETUP.md (CREATE)"
    }
  ]
}
